# **ğŸ“Š MongoDB Monitoring & Profiling â€“ Detecting Performance Issues & Bottlenecks ğŸš€**

MongoDB **performance issues** often arise from **poor query patterns, excessive disk I/O, memory pressure, or inefficient indexing**. **Monitoring** and **profiling** help detect these issues before they cause serious problems.

---

## **ğŸ“¡ 1ï¸âƒ£ MongoDB Monitoring â€“ How to Detect Performance Issues**

ğŸ’¡ **MongoDB provides built-in tools and external monitoring solutions to track database performance.**

### **ğŸ” Built-in MongoDB Monitoring Tools**

| **Tool**                                | **Purpose**                                                     |
| --------------------------------------- | --------------------------------------------------------------- |
| **`db.stats()`**                        | Provides an overview of database size, storage, and indexes.    |
| **`db.serverStatus()`**                 | Returns detailed server health metrics (CPU, memory, disk I/O). |
| **`mongostat`**                         | Real-time database statistics (queries/sec, inserts/sec).       |
| **`mongotop`**                          | Shows how much time MongoDB spends reading/writing collections. |
| **MongoDB Ops Manager / Cloud Manager** | Full-featured monitoring for MongoDB clusters.                  |
| **Prometheus + Grafana**                | Custom monitoring dashboards for MongoDB.                       |

---

### **ğŸ’¡ How to Check MongoDB Server Health**

âœ”ï¸ **Check MongoDB System Status**

```bash
db.serverStatus()
```

âœ”ï¸ **Monitor Active Connections**

```bash
db.serverStatus().connections
```

âœ”ï¸ **Check Memory Usage & Cache Efficiency**

```bash
db.serverStatus().wiredTiger.cache
```

---

### **ğŸ” `mongostat` â€“ Real-Time MongoDB Monitoring**

ğŸ’¡ **`mongostat` provides a live view of MongoDB performance.**

```bash
mongostat --host localhost --port 27017
```

âœ”ï¸ **Shows real-time read/write operations.**  
âœ”ï¸ **Monitors query execution, insert/update/delete rates.**  
âœ”ï¸ **Detects replication lag in replica sets.**

Example Output:

```ini
insert query update delete getmore command dirty used flushes vsize   res
     12    32      5      3      10      8     0.5   60%    5     1GB  512MB
```

âœ”ï¸ **High insert/query rates = Good performance.**  
âœ”ï¸ **Low dirty % and low flushes = Efficient memory usage.**  
âœ”ï¸ **High command execution time = Possible performance issue.**

---

### **ğŸ” `mongotop` â€“ Collection Read/Write Time Monitoring**

ğŸ’¡ **`mongotop` shows how much time MongoDB spends reading & writing collections.**

```bash
mongotop
```

âœ”ï¸ **Helps identify slow collections.**  
âœ”ï¸ **Shows which collections are consuming the most I/O.**  
âœ”ï¸ **Useful for detecting high disk usage issues.**

Example Output:

```ini
                        ns         total      read    write
database.users          30ms       25ms      5ms
database.orders         50ms       40ms      10ms
```

âœ”ï¸ **High read time = Indexes missing or too many queries.**  
âœ”ï¸ **High write time = Frequent updates/inserts, possible write locks.**

---

## **ğŸ” 2ï¸âƒ£ MongoDB Profiling â€“ Identifying Slow Queries & Bottlenecks**

ğŸ’¡ **MongoDB provides the Query Profiler to detect slow queries and optimize them.**

### **ğŸ“Œ Enabling Query Profiling**

âœ”ï¸ **Enable profiling for slow queries (queries that take longer than 100ms).**

```bash
db.setProfilingLevel(1, 100)  # Logs queries slower than 100ms
```

âœ”ï¸ **Enable profiling for all queries (for deep analysis).**

```bash
db.setProfilingLevel(2)  # Logs all queries (use with caution)
```

âœ”ï¸ **Check profiling status.**

```bash
db.getProfilingStatus()
```

---

### **ğŸ” Viewing Slow Queries in the Profiler**

âœ”ï¸ **Find the slowest queries in the profiler.**

```bash
db.system.profile.find().sort({ millis: -1 }).limit(5)
```

âœ”ï¸ **Example Output (Shows Queries Taking Over 200ms)**

```json
{
  "op": "query",
  "ns": "users",
  "query": { "email": "ahmed@example.com" },
  "keysExamined": 500000,
  "docsExamined": 500000,
  "executionTimeMillis": 225
}
```

ğŸ’¡ **Problem: The query is scanning 500,000 documents (full collection scan).**  
âœ”ï¸ **Solution: Create an index on `email`.**

```bash
db.users.createIndex({ "email": 1 })
```

---

## **ğŸ“Š 3ï¸âƒ£ Key Metrics to Monitor in MongoDB**

ğŸ’¡ **MongoDB performance depends on CPU, Memory, Disk, and Network usage.**

| **Metric**             | **What It Means**                               | **How to Monitor**                 |
| ---------------------- | ----------------------------------------------- | ---------------------------------- |
| **CPU Usage**          | High CPU = Expensive queries                    | `top`, `htop`, `db.serverStatus()` |
| **Memory Usage**       | Should be < 75% of available RAM                | `db.serverStatus().mem`            |
| **Disk I/O**           | High disk usage = Slow queries, missing indexes | `mongotop`, `iostat`               |
| **Active Connections** | Too many connections = Bottlenecks              | `db.serverStatus().connections`    |
| **Replication Lag**    | High lag = Slow replication                     | `rs.status()`                      |
| **Locking**            | High lock time = Blocking writes                | `db.currentOp()`                   |

âœ”ï¸ **Monitor these metrics to prevent performance issues before they become critical.**

---

## **ğŸ¯ 4ï¸âƒ£ Sequence Diagram â€“ How MongoDB Monitoring Works**

```mermaid
sequenceDiagram
    participant User as Database Admin
    participant MonitoringTool as Monitoring System
    participant MongoDB as MongoDB Server
    participant Disk as Disk Storage

    User->>MonitoringTool: Check MongoDB Performance Metrics
    MonitoringTool->>MongoDB: Fetch CPU, Memory, Disk, Query Execution Time
    MongoDB->>MonitoringTool: Return Performance Data
    MonitoringTool->>User: Display Performance Dashboard
    alt Slow Query Detected
        MonitoringTool->>MongoDB: Fetch Slow Queries from Profiler
        MongoDB->>MonitoringTool: Return Slow Query Logs
        MonitoringTool->>User: Suggest Indexing / Optimization
    end
```

ğŸ’¡ **Key Takeaways from Monitoring:**  
âœ”ï¸ **Automated monitoring tools detect slow queries & performance issues.**  
âœ”ï¸ **Alerts can be set up for high CPU, memory, or replication lag.**  
âœ”ï¸ **Profiling helps detect slow queries that need optimization.**

---

## **ğŸ† 5ï¸âƒ£ Summary â€“ MongoDB Performance Monitoring & Profiling Best Practices**

âœ”ï¸ **Use `mongostat`, `mongotop`, and `db.serverStatus()` to monitor real-time performance.**  
âœ”ï¸ **Enable profiling to detect slow queries.**  
âœ”ï¸ **Optimize slow queries using indexes and aggregation improvements.**  
âœ”ï¸ **Monitor CPU, Memory, Disk I/O, and Network for system health.**  
âœ”ï¸ **Use Prometheus, Grafana, or MongoDB Ops Manager for advanced monitoring.**  
âœ”ï¸ **Set alerts for slow queries, high CPU usage, and replication lag.**
