# üêò **PostgreSQL 17 Replication: Setup & Configuration for Each Type**

PostgreSQL 17 enhances replication capabilities, making it more **efficient, robust, and easier to manage**. This guide covers **all replication types**, including **WAL Shipping, Streaming Replication, Logical Replication, and Pgpool-II**, along with **how primary and standby servers discover and connect to each other** in a **Dockerized environment**.

---

## üöÄ **1Ô∏è‚É£ Write-Ahead Log (WAL) Shipping ‚Äì Setup & Configuration**

### üèó **How Primary & Standby Connect**

- **Primary archives WAL files** into a **shared storage location** (local volume, NFS, S3, etc.).
- **Standby periodically fetches and replays** the WAL files to stay in sync.
- **No real-time streaming**; replication happens in intervals.

### ‚úÖ **Step 1: Start Primary Server (Docker)**

1. **Create a Docker network**:

   ```bash
   docker network create pg_net
   ```

2. **Run the primary PostgreSQL container**:

   ```bash
   docker run -d --name primary \
     --network pg_net \
     -e POSTGRES_USER=postgres \
     -e POSTGRES_PASSWORD=secret \
     -e POSTGRES_DB=mydb \
     -v pg_wal_archive:/var/lib/postgresql/wal_archive \
     postgres:17
   ```

3. **Modify `postgresql.conf` inside the container**:

   ```ini
   archive_mode = on
   archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'
   wal_level = replica
   max_wal_senders = 3
   ```

4. **Restart PostgreSQL**:

   ```bash
   docker exec -it primary psql -U postgres -c "SELECT pg_reload_conf();"
   ```

---

### ‚úÖ **Step 2: Start Standby Server (Docker)**

1. **Run the standby container**:

   ```bash
   docker run -d --name standby \
     --network pg_net \
     -e POSTGRES_USER=postgres \
     -e POSTGRES_PASSWORD=secret \
     -e POSTGRES_DB=mydb \
     -v pg_wal_archive:/var/lib/postgresql/wal_archive \
     postgres:17
   ```

2. **Modify `recovery.conf` (PostgreSQL 12 and below)**:

   ```ini
   restore_command = 'cp /var/lib/postgresql/wal_archive/%f %p'
   standby_mode = on
   ```

3. **Restart Standby**:

   ```bash
   docker exec -it standby psql -U postgres -c "SELECT pg_reload_conf();"
   ```

üìå **Verification**:

- Check WAL files:

  ```bash
  docker exec -it primary ls /var/lib/postgresql/wal_archive/
  ```

- Monitor Standby Logs:

  ```bash
  docker logs standby
  ```

---

## üîÑ **2Ô∏è‚É£ Streaming Replication ‚Äì Setup & Configuration**

### üèó **How Primary & Standby Connect**

- The **Primary Server streams WAL logs** in real-time over the network.
- The **Standby Server continuously receives** and applies the WAL logs.
- **The primary must allow the standby's IP in `pg_hba.conf`.**

### ‚úÖ **Step 1: Start Primary Server (Docker)**

1. **Run the primary server**:

   ```bash
   docker run -d --name primary \
     --network pg_net \
     -e POSTGRES_USER=postgres \
     -e POSTGRES_PASSWORD=secret \
     -e POSTGRES_DB=mydb \
     postgres:17
   ```

2. **Modify `postgresql.conf` inside the container**:

   ```ini
   wal_level = replica
   max_wal_senders = 5
   hot_standby = on
   synchronous_commit = on  # Optional for sync replication
   ```

3. **Create a replication user**:

   ```sql
   CREATE USER replication WITH REPLICATION ENCRYPTED PASSWORD 'secret';
   ```

4. **Allow the standby to connect (`pg_hba.conf`)**:

   ```ini
   host replication replication standby md5
   ```

5. **Restart PostgreSQL**:

   ```bash
   docker exec -it primary psql -U postgres -c "SELECT pg_reload_conf();"
   ```

---

### ‚úÖ **Step 2: Start Standby Server (Docker)**

1. **Run the standby server**:

   ```bash
   docker run -d --name standby \
     --network pg_net \
     -e POSTGRES_USER=postgres \
     -e POSTGRES_PASSWORD=secret \
     -e POSTGRES_DB=mydb \
     postgres:17
   ```

2. **Take a base backup from the primary**:

   ```bash
   docker exec -it standby pg_basebackup -h primary -D /var/lib/postgresql/data -U replication -P -R
   ```

3. **Modify `postgresql.conf` for standby**:

   ```ini
   primary_conninfo = 'host=primary port=5432 user=replication password=secret'
   ```

4. **Restart Standby**:

   ```bash
   docker exec -it standby psql -U postgres -c "SELECT pg_reload_conf();"
   ```

üìå **Verification**:

- Check replication status:

  ```sql
  SELECT * FROM pg_stat_replication;
  ```

- Monitor logs:

  ```bash
  docker logs standby
  ```

---

## üîÄ **3Ô∏è‚É£ Logical Replication ‚Äì Setup & Configuration**

### üèó **How Primary & Standby Connect**

- The **Primary Server publishes specific tables**.
- The **Standby Server subscribes** to receive changes.
- **Logical replication does not require full database replication.**

### ‚úÖ **Step 1: Start Primary Server (Docker)**

1. **Enable logical replication** in `postgresql.conf`:

   ```ini
   wal_level = logical
   max_replication_slots = 5
   max_wal_senders = 5
   sync_replication_slots = true
   ```

2. **Create a publication**:

   ```sql
   CREATE PUBLICATION my_pub FOR TABLE users, orders;
   ```

---

### ‚úÖ **Step 2: Start Standby Server (Docker)**

1. **Create a subscription**:

   ```sql
   CREATE SUBSCRIPTION my_sub CONNECTION 'host=primary user=replication password=secret' PUBLICATION my_pub;
   ```

üìå **Verification**:

- Check subscription status:

  ```sql
  SELECT * FROM pg_stat_subscription;
  ```

- Insert data into the primary:

  ```sql
  INSERT INTO users VALUES (1, 'Alice');
  ```

- Query the standby:

  ```sql
  SELECT * FROM users;
  ```

---

## ‚ö° **4Ô∏è‚É£ SQL-Based Replication Middleware (Pgpool-II) ‚Äì Setup & Configuration**

1. **Install Pgpool-II**:

   ```bash
   sudo apt install pgpool2
   ```

2. **Modify `pgpool.conf`**:

   ```ini
   listen_addresses = '*'
   backend_hostname0 = 'primary'
   backend_port0 = 5432
   backend_weight0 = 1
   backend_flag0 = 'ALLOW_TO_FAILOVER'
   replicate_select = on
   load_balance_mode = on
   ```

3. **Restart Pgpool-II**:

   ```bash
   sudo systemctl restart pgpool2
   ```

üìå **Verification**:

- Run a test query via Pgpool:

  ```sql
  SELECT * FROM pg_stat_replication;
  ```

---

## üéØ **Final Summary: PostgreSQL 17 Replication**

| Replication Type          | Connection Method                | Best For                       |
| ------------------------- | -------------------------------- | ------------------------------ |
| **WAL Shipping**          | Shared Storage (NFS, S3, Volume) | Disaster Recovery              |
| **Streaming Replication** | Direct WAL Streaming             | High Availability              |
| **Logical Replication**   | SQL-Based Publication            | Selective Replication          |
| **Pgpool-II**             | Middleware                       | Load Balancing & Auto Failover |

üí° **Next, we will explore detailed Failover & Failback setups in PostgreSQL 17! üöÄüî•**
