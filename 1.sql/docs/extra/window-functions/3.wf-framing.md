# ü™ü **Window Function Framing**

## üîô **First, What is a Window Function?**

- A **window function** looks at a **set of rows (a window)** relative to the current row.
- For each row ‚Üí it calculates something (sum, average, rank, lag, etc.) based on that window.

The **`OVER()` clause** defines that window.

---

## ü§î **What Defines a Window?**

A window is built from **3 layers**:

1. **PARTITION BY** ‚Üí _which group of rows?_
   (like `GROUP BY`, but without collapsing rows)

2. **ORDER BY** ‚Üí _in what sequence inside that group?_

3. **FRAME** ‚Üí _which subset of those ordered rows should each row look at?_

---

## üí≠ **Why Do We Need Frames?**

- Without frames: you only get running totals or whole-partition results.
- With frames: you can zoom in ‚Üí _‚Äújust the last 3 rows‚Äù_ or _‚Äúfrom start to here‚Äù_.

‚û°Ô∏è Frames give **fine-grained control** over ‚Äúwhich rows each calculation sees.‚Äù

---

## üé≠ **Types of Frames**

There are **3 important concepts** in framing:

### 1Ô∏è‚É£ **Row-based frames**

- Defined by **physical rows** relative to the current one.
- Example:

  ```sql
  ROWS BETWEEN 1 PRECEDING AND CURRENT ROW
  ```

  ‚Üí current row + 1 before it.

---

<div align="center">
  <img src="image/.md/1755777545609.png" alt="1755777545609" style="border-radius: 10px; border: 2px solid; width: 80%">
</div>

<div align="center">
  <img src="image/.md/1755777549484.png" alt="1755777549484" style="border-radius: 10px; border: 2px solid; width: 80%">
</div>

---

### 2Ô∏è‚É£ **Range-based frames**

- Defined by **values** in the `ORDER BY` column.
- Example:

  ```sql
  RANGE BETWEEN 100 PRECEDING AND CURRENT ROW
  ```

  ‚Üí includes all rows whose value is within `100` of the current row‚Äôs value.

---

<div align="center">
  <img src="image/.md/1755777576406.png" alt="1755777576406" style="border-radius: 10px; border: 2px solid; width: 80%">
</div>

<div align="center">
  <img src="image/.md/1755777594825.png" alt="1755777594825" style="border-radius: 10px; border: 2px solid; width: 80%">
</div>

---

### üìå **Defaults**

- If you say just:

  ```sql
  SUM(Salary) OVER (ORDER BY HireDate)
  ```

  SQL Server _assumes_:

  ```sql
  ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
  ```

  ‚û°Ô∏è i.e., **running total**.

---

<div align="center">
  <img src="image/.md/1755777643446.png" alt="1755777643446" style="border-radius: 10px; border: 2px solid; width: 80%">
</div>

---

## üèõÔ∏è **Frame Options**

Here are the building blocks:

- **UNBOUNDED PRECEDING**
  - ROW ‚Üí ‚Äúfrom the first row of the partition.‚Äù
  - RANGE ‚Üí ‚Äúfrom the very first row of the partition.‚Äù
- **CURRENT ROW**
  - ‚Äújust this row.‚Äù
- **N PRECEDING**
  - ‚ÄúN rows before.‚Äù
- **N FOLLOWING**
  - ‚ÄúN rows after.‚Äù
- **UNBOUNDED FOLLOWING**
  - ROWS ‚Üí ‚Äúto the last row of the partition.‚Äù
  - RANGE ‚Üí ‚Äúto the very last row of the partition.‚Äù

---

## ‚úçüèª **Examples**

Suppose we have salaries ordered by hire date:

| Row | Salary |
| --- | ------ |
| 1   | 4000   |
| 2   | 4500   |
| 3   | 5000   |
| 4   | 6000   |

---

### Example 1: Running Total (default)

```sql
SUM(Salary) OVER (ORDER BY HireDate)
```

Frame = `UNBOUNDED PRECEDING ‚Üí CURRENT ROW`

| Row | Frame Rows            | SUM   |
| --- | --------------------- | ----- |
| 1   | {4000}                | 4000  |
| 2   | {4000,4500}           | 8500  |
| 3   | {4000,4500,5000}      | 13500 |
| 4   | {4000,4500,5000,6000} | 19500 |

---

### Example 2: Moving Window (last 2 rows)

```sql
SUM(Salary) OVER (
  ORDER BY HireDate
  ROWS BETWEEN 1 PRECEDING AND CURRENT ROW
)
```

| Row | Frame Rows  | SUM   |
| --- | ----------- | ----- |
| 1   | {4000}      | 4000  |
| 2   | {4000,4500} | 8500  |
| 3   | {4500,5000} | 9500  |
| 4   | {5000,6000} | 11000 |

---

### Example 3: Centered Window

```sql
AVG(Salary) OVER (
  ORDER BY HireDate
  ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING
)
```

| Row | Frame Rows       | AVG  |
| --- | ---------------- | ---- |
| 1   | {4000,4500}      | 4250 |
| 2   | {4000,4500,5000} | 4500 |
| 3   | {4500,5000,6000} | 5167 |
| 4   | {5000,6000}      | 5500 |

---

### Example 4: Whole Partition

```sql
SUM(Salary) OVER (
  ORDER BY HireDate
  ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
)
```

| Row | Frame Rows            | SUM   |
| --- | --------------------- | ----- |
| 1   | {4000,4500,5000,6000} | 19500 |
| 2   | {4000,4500,5000,6000} | 19500 |
| 3   | {4000,4500,5000,6000} | 19500 |
| 4   | {4000,4500,5000,6000} | 19500 |

---

## üéØ Big Takeaways

1. **Partition** = who‚Äôs in the group.
2. **Order** = how they‚Äôre lined up.
3. **Frame** = which slice of that lineup is visible to each row.

- Default = _running frame_ (start ‚Üí current row).
- Frames let you do **running totals, moving averages, rolling sums, centered windows, full totals**, etc.
